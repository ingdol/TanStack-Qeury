# 5. useQuery

[GitHub - ssi02014/react-query-tutorial: ğŸ˜ƒ TanStack Query(aka. react query) ì—ì„œ ìì£¼ ì‚¬ìš©ë˜ëŠ” ê°œë… ì •ë¦¬](https://github.com/ssi02014/react-query-tutorial?tab=readme-ov-file#usequery)

# useQuery ê¸°ë³¸ ë¬¸ë²•

- `v5` ë¶€í„° ì¸ìë¡œ ë‹¨ í•˜ë‚˜ì˜ `ê°ì²´` ë§Œ ë°›ìŒ
  - `queryKey` , `queryFn` : ì²« ë²ˆì§¸ ì¸ìì´ì í•„ìˆ˜ ê°’

```jsx
const result = useQuery({
  queryKey, // required
  queryFn, // required
  // ...options ex) gcTime, staleTime, select, ...
});

result.data;
result.isLoading;
result.refetch;
// ...
```

```jsx
// ì‹¤ì œ ì˜ˆì œ
const getRepos = async () => {
  return await axios.get(
    'https://api.github.com/repos/tannerlinsley/react-query'
  );
};

const { data } = useQuery({
  queryKey: ['repoData'],
  queryFn: getRepos,
});
```

## 1. queryKey

```tsx
// (1) queryKeyëŠ” ë°ì´í„°ë¥¼ ê³ ìœ í•˜ê²Œ ì‹ë³„ì— ë”í•´ ì¿¼ë¦¬ í•¨ìˆ˜ì— ì•„ë˜ì™€ ê°™ì´ í¸ë¦¬í•˜ê²Œ ì „ë‹¬í•  ìˆ˜ ìˆìŒ

export const getUserInfo = async ({ queryKey }) => {
  const userId = queryKey[1]; // ['user-info', '1']
  const response = await axios.get(
    `https://jsonplaceholder.typicode.com/users/${userId}`
  );
  return response?.data;
};

export const useUserInfoData = (userId) => {
  return useQuery({
    queryKey: ['user-info', userId],
    queryFn: getUserInfo,
  });
};
```

```tsx
// ì „ì²´ ì‹¤í–‰ ì½”ë“œ

import { useQuery } from '@tanstack/react-query';
import { QueryClient, QueryClientProvider } from '@tanstack/react-query';
import { ReactQueryDevtools } from '@tanstack/react-query-devtools';
import axios from 'axios';

const queryClient = new QueryClient();

export default function App() {
  return (
    <QueryClientProvider client={queryClient}>
      <ReactQueryDevtools initialIsOpen={false} />
      <Example />
    </QueryClientProvider>
  );
}

function Example() {
  const { data } = useUserInfoData(1);
  return <div>{data?.id}</div>;
}

export const getUserInfo = async ({ queryKey }) => {
  const userId = queryKey[1];
  const response = await axios.get(
    `https://jsonplaceholder.typicode.com/users/${userId}`
  );
  return response?.data;
};

export const useUserInfoData = (userId) => {
  return useQuery({
    queryKey: ['user-info', userId],
    queryFn: getUserInfo,
  });
};
```

- useQueryì˜ queryKeyëŠ” `ë°°ì—´` ë¡œ ì§€ì •í•´ì¤˜ì•¼ í•¨
  - ë‹¨ì¼ ë¬¸ìì—´ë§Œ í¬í•¨ëœ ë°°ì—´ì´ ë  ìˆ˜ë„ ìˆê³ , ì—¬ëŸ¬ ë¬¸ìì—´ê³¼ ì¤‘ì²©ëœ ê°ì²´ë¡œ êµ¬ì„±ëœ ë³µì¡í•œ í˜•íƒœì¼ ìˆ˜ ìˆìŒ

```tsx
// An individual todo
useQuery({ queryKey: ["todo", 5], ... })

// An individual todo in a "preview" format
useQuery({ queryKey: ["todo", 5, { preview: true }], ...})
```

- useQueryëŠ” `queryKey` ë¥¼ ê¸°ë°˜ìœ¼ë¡œ `ì¿¼ë¦¬ ìºì‹±` ì„ ê´€ë¦¬í•˜ëŠ” ê²ƒì´ í•µì‹¬ì„
  - ë§Œì•½, ì¿¼ë¦¬ê°€ íŠ¹ì • ë³€ìˆ˜ì— `ì˜ì¡´` í•œë‹¤ë©´ ë°°ì—´ì—ë‹¤ ì´ì–´ì„œ ì¤˜ì•¼ í•¨
    - ex ) ['user-info', userId, â€¦ ]
  - ì´ëŠ” ì‚¬ì‹¤ êµ‰ì¥íˆ ì¤‘ìš”í•¨. ì˜ˆë¥¼ ë“¤ì–´, `queryClient.setQueryData` ë“±ê³¼ ê°™ì´ íŠ¹ì • ì¿¼ë¦¬ì— ì ‘ê·¼ì´ í•„ìš”í•  ë•Œ `ì´ˆê¸°ì— ì„¤ì •í•´ë‘” í¬ë§·` ì„ ì§€ì¼œì¤˜ì•¼ ì œëŒ€ë¡œ ì¿¼ë¦¬ì— ì ‘ê·¼í•  ìˆ˜ ìˆìŒ
  - ì•„ë˜ options ì˜ˆì œë¥¼ ì‚´í´ë³´ë©´ useSuperHerorDataì˜ queryKeyëŠ” `['user-info', userId]` ì„, ê·¸ë ‡ë‹¤ë©´ queryClient.setQueryDataë¥¼ ì´ìš©í•  ë•Œ ë˜‘ê°™ì´ `['user-info', userId]` í¬ë§·ì„ ê°€ì ¸ì•¼ í•¨. ê·¸ë ‡ì§€ ì•Šìœ¼ë©´ ì›í•˜ëŠ” ì¿¼ë¦¬ì— ì ‘ê·¼í•  ìˆ˜ ì—†ìŒ

## 2. queryFn

- useQueryì˜ queryFnì€ `Promise` ë¥¼ ë°˜í™˜í•˜ëŠ” í•¨ìˆ˜ë¥¼ ë„£ì–´ì•¼ í•¨

```tsx
// (2) ìƒë‹¨ì˜ queryKey ì˜ˆì œì™€ ë°˜ëŒ€ë¡œ queryFn ìì²´ì ìœ¼ë¡œ ì¸ìë¥¼ ë°›ëŠ” í˜•íƒœ

export const getUserInfo = async (userId) => {
  const response = await axios.get(
    `https://jsonplaceholder.typicode.com/users/${userId}`
  );
  return response?.data;
};

export const useUserInfoData = (userId) => {
  return useQuery({
    queryKey: ['user-info', userId],
    queryFn: () => getUserInfo(userId),
  });
};
```

## 3. options

[useQuery | TanStack Query Docs](https://tanstack.com/query/v5/docs/framework/react/reference/useQuery)

```tsx
export const useUserInfoData = (userId) => {
  return useQuery({
    queryKey: ['user-info', userId],
    queryFn: () => getUserInfo(userId),
    gcTime: 5 * 60 * 1000, // 5ë¶„
    staleTime: 1 * 60 * 1000, // 1ë¶„
    retry: 1,
    // ... options
  });
};
```

# useQuery ì£¼ìš” ë¦¬í„´ ë°ì´í„°

```tsx
const {
  data,
  error,
  status,
  fetchStatus,
  isLoading,
  isFetching,
  isError,
  refetch,
  // ...
} = useQuery({
  queryKey: ['user-info'],
  queryFn: getAllSuperHero,
});
```

- `data` : ì¿¼ë¦¬ í•¨ìˆ˜ê°€ ë¦¬í„´í•œ `promise`ì—ì„œ `resolved` ëœ ë°ì´í„°
- `error` : ì¿¼ë¦¬ í•¨ìˆ˜ì— ì˜¤ë¥˜ê°€ ë°œìƒí•œ ê²½ìš°, ì¿¼ë¦¬ì— ëŒ€í•œ ì˜¤ë¥˜ ê°ì²´
- `status` : `data` , ì¿¼ë¦¬ ê²°ê³¼ê°’ì— ëŒ€í•œ ìƒíƒœë¥¼ í‘œí˜„í•˜ëŠ” statusëŠ” ë¬¸ìì—´ í˜•íƒœ `3ê°€ì§€` ì˜ ê°’ì´ ì¡´ì¬í•¨
  - `pending` : ì¿¼ë¦¬ ë°ì´í„°ê°€ ì—†ê³ , ì¿¼ë¦¬ ì‹œë„ê°€ ì•„ì§ ì™„ë£Œë˜ì§€ ì•Šì€ ìƒíƒœ
    - `{ enabled : false }` ìƒíƒœë¡œ ì¿¼ë¦¬ê°€ í˜¸ì¶œë˜ë©´ ì´ ìƒíƒœë¡œ ì‹œì‘ë¨
  - `error` : ì—ëŸ¬ê°€ ë°œìƒí–ˆì„ ë•Œ ìƒíƒœ
  - `success` : ì¿¼ë¦¬ í•¨ìˆ˜ê°€ ì˜¤ë¥˜ ì—†ì´ ìš”ì²­ ì„±ê³µí•˜ê³  ë°ì´í„°ë¥¼ í‘œì‹œí•  ì¤€ë¹„ê°€ ëœ ìƒíƒœ
- `fetchStatus` : `queryFn` ì— ëŒ€í•œ ì •ë³´ë¥¼ ë‚˜íƒ€ëƒ„
  - `fetching` : ì¿¼ë¦¬ê°€ í˜„ì¬ ì‹¤í–‰ ì¤‘ì¸ ìƒíƒœ
  - `paused` : ì¿¼ë¦¬ë¥¼ ìš”ì²­í–ˆì§€ë§Œ, ì ì‹œ ì¤‘ë‹¨ëœ ìƒíƒœ(network modeì™€ ì—°ê´€)
  - `idle` : ì¿¼ë¦¬ê°€ í˜„ì¬ ì•„ë¬´ ì‘ì—…ë„ ìˆ˜í–‰í•˜ì§€ ì•ŠëŠ” ìƒíƒœ
- `isLoading` : `ìºì‹± ëœ ë°ì´í„°ê°€ ì—†ì„ ë•Œ` ì¦‰, ì²˜ìŒ ì‹¤í–‰ëœ ì¿¼ë¦¬ì¼ ë•Œ ë¡œë”© ì—¬ë¶€ì— ë”°ë¼ `true/false` ë¡œ ë°˜í™˜ë¨
  - ì´ëŠ” ìºì‹± ëœ ë°ì´í„°ê°€ ìˆë‹¤ë©´ ë¡œë”© ì—¬ë¶€ì— ìƒê´€ì—†ì´ `false`ë¥¼ ë°˜í™˜í•¨
  - `isFetching && isPending` ê³¼ ë™ì¼í•¨
- `isFetching` : ìºì‹± ëœ ë°ì´í„°ê°€ ìˆë”ë¼ë„ ì¿¼ë¦¬ê°€ ì‹¤í–‰ë˜ë©´ ë¡œë”© ì—¬ë¶€ì— ë”°ë¼ `true/false` ë¡œ ë°˜í™˜ë¨
- `isSuccess` : ì¿¼ë¦¬ ìš”ì²­ì´ ì„±ê³µí•˜ë©´ `true`
- `isError` : ì¿¼ë¦¬ ìš”ì²­ ì¤‘ì— ì—ëŸ¬ê°€ ë°œìƒí•œ ê²½ìš° `true`
- `refetch` : ì¿¼ë¦¬ë¥¼ ìˆ˜ë™ìœ¼ë¡œ ë‹¤ì‹œ ê°€ì ¸ì˜¤ëŠ” í•¨

### status, fetchStatus ë‚˜ëˆ ì„œ ë‹¤ë£¨ëŠ” ì´ìœ 

- `fetchStatus` ëŠ” HTTP ë„¤íŠ¸ì›Œí¬ ì—°ê²° ìƒíƒœì™€ ì¢€ ë” ê´€ë ¨ëœ ìƒíƒœ ë°ì´í„°ì„
  - ì˜ˆë¥¼ ë“¤ì–´, statusê°€ `success` ìƒíƒœë¼ë©´ ì£¼ë¡œ fetchStatusëŠ” `idle` ìƒíƒœì§€ë§Œ, ë°±ê·¸ë¼ìš´ë“œì—ì„œ re-fetchê°€ ë°œìƒí•  ë•Œ `fetching` ìƒíƒœì¼ ìˆ˜ ìˆìŒ
  - statusê°€ ë³´í†µ `loading` ìƒíƒœì¼ ë•Œ fetchStatusëŠ” ì£¼ë¡œ `fetching` ë¥¼ ê°–ì§€ë§Œ, ë„¤íŠ¸ì›Œí¬ ì—°ê²°ì´ ë˜ì–´ ìˆì§€ ì•ŠëŠ” ê²½ìš° `paused` ìƒíƒœë¥¼ ê°€ì§ˆ ìˆ˜ ìˆìŒ
- ê²°ë¡ 
  - `status` ëŠ” `data` ê°€ ìˆëŠ”ì§€ ì—†ëŠ”ì§€ì— ëŒ€í•œ ìƒíƒœë¥¼ ì˜ë¯¸í•¨
  - `fetchStatus` ëŠ” ì¿¼ë¦¬ ì¦‰, `queryFn ìš”ì²­` ì´ ì§„í–‰ ì¤‘ì¸ì§€ ì•„ë‹Œì§€ì— ëŒ€í•œ ìƒíƒœë¥¼ ì˜ë¯¸í•¨
